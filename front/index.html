<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
			crossorigin="anonymous"
		/>
		<title>Classic cars</title>

		<!-- Favicons -->
		<link
			rel="apple-touch-icon"
			href="./imgs/apple-touch-icon.png"
			sizes="180x180"
		/>
		<link
			rel="icon"
			href="./imgs/favicon-32x32.png"
			sizes="32x32"
			type="image/png"
		/>
		<link
			rel="icon"
			href="./imgs/favicon-16x16.png"
			sizes="16x16"
			type="image/png"
		/>
		<link rel="manifest" href="./imgs/manifest.json" />
		<link
			rel="mask-icon"
			href="/docs/5.0/assets/img/favicons/safari-pinned-tab.svg"
			color="#7952b3"
		/>
		<link rel="icon" href="./imgs/favicon.ico" />
		<meta name="theme-color" content="#7952b3" />
		<style>
			/* Styles pour les cartes de voitures */
			.card {
				width: 32.5%;
				min-width: 355px;
				border: none;
				border-radius: 12px;
				overflow: hidden;
				transition: transform 0.3s ease, box-shadow 0.3s ease;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}
			
			.card:hover {
				transform: translateY(-5px);
				box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
			}
			
			.card img {
				min-width: 410px;
				transition: all 250ms ease-in-out;
				object-fit: cover;
			}
			
			.card img:hover {
				min-width: 480px;
				transform: scale(1.05);
			}
			
			.card a:first-child {
				overflow: hidden;
				display: flex;
				align-items: center;
				justify-content: center;
				height: 235px;
				background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
			}
			
			.card-body {
				padding: 1.25rem;
				background: #fff;
			}
			
			.card-title {
				font-size: 1.25rem;
				font-weight: 600;
				margin-bottom: 0.75rem;
				color: #2c3e50;
			}
			
			.card-text {
				font-size: 0.9rem;
				color: #6c757d;
				margin-bottom: 1rem;
				line-height: 1.5;
				min-height: 3em;
			}
			
			/* Styles pour les boutons - Styles Bootstrap de base */
			.button-container .btn {
				font-size: 0.875rem;
				padding: 0.375rem 0.75rem;
			}
			
			.button-container .btn-primary {
				color: #000000 !important;
			}
			
			.button-container .btn-primary:hover {
				color: #000000 !important;
			}
			
			/* Conteneur de boutons */
			.button-container {
				display: flex;
				gap: 0.5rem;
				margin-top: 0.75rem;
			}
			
			/* Section principale */
			.card-cont {
				padding: 2rem 0;
				min-height: 60vh;
			}
			
			/* Header am√©lior√© */
			.navbar {
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				background: #fff !important;
			}
			
			.navbar-brand {
				font-weight: 600;
				font-size: 1.3rem;
				color: #2c3e50 !important;
			}
			
			/* Titre principal */
			h1 {
				font-weight: 700;
				color: #2c3e50;
				margin-bottom: 2rem;
				text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			
			/* Bouton flottant "Add car" */
			.position-fixed.bottom-0.end-0 {
				border-radius: 50px;
				padding: 0.75rem 1.5rem;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
				font-weight: 600;
				z-index: 1000;
			}
			
			.position-fixed.bottom-0.end-0:hover {
				box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
				transform: translateY(-2px);
			}
			
			/* Modal am√©lior√© */
			.modal-content {
				border-radius: 12px;
				border: none;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			}
			
			.modal-header {
				border-bottom: 1px solid #e9ecef;
				padding: 1.5rem;
			}
			
			.modal-body {
				padding: 1.5rem;
			}
			
			.modal-footer {
				border-top: 1px solid #e9ecef;
				padding: 1rem 1.5rem;
			}
			
			/* Form inputs */
			.form-control {
				border-radius: 6px;
				border: 1px solid #dee2e6;
				padding: 0.5rem 0.75rem;
				transition: all 0.2s ease;
			}
			
			.form-control:focus {
				border-color: #667eea;
				box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
			}
			
			/* Alerte vide */
			.alert-info {
				border-radius: 8px;
				border: none;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}
		</style>
	</head>
	<body>
		<header>
			<nav class="navbar navbar-expand-md" aria-label="Classic cars site">
				<div class="container">
					<a class="navbar-brand" href="#">
						<img
							src="./imgs/logo-180.png"
							alt="classic cars"
							width="40"
							height="38"
							class="img-fluid"
						/>
						Classic Cars
					</a>
					<div>
						<button
							class="navbar-toggler collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#navbarsExample04"
							aria-controls="navbarsExample04"
							aria-expanded="false"
							aria-label="Toggle navigation"
						>
							<span class="navbar-toggler-icon"></span>
						</button>

						<div class="navbar-collapse collapse" id="navbarsExample04">
							<ul class="navbar-nav me-auto mb-2 mb-md-0">
								<li class="nav-item">
									<a class="nav-link active" aria-current="page" href="#"
										>Home</a
									>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</nav>
		</header>
		<main style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 2rem 0;">
			<div class="container">
				<h1 class="text-center mt-4 mb-5">Classic Cars Collection</h1>
				<section
					class="card-cont d-flex flex-wrap justify-content-center gap-3"
				>
					<!-- Les cartes de voitures seront g√©n√©r√©es dynamiquement par JavaScript -->
				</section>
			</div>
			<!-- Button trigger modal -->
			<button
				type="button"
				class="btn btn-primary position-fixed bottom-0 end-0 m-4"
				data-bs-toggle="modal"
				data-bs-target="#exampleModal"
			>
				Add car
			</button>

			<!-- Modal -->
			<div
				class="modal fade"
				id="exampleModal"
				tabindex="-1"
				aria-labelledby="exampleModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog">
					<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="exampleModalLabel">
							Ajouter une voiture classique
						</h1>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<form id="addCarForm" novalidate onsubmit="return window.handleFormSubmitGlobal ? window.handleFormSubmitGlobal(event) : false;">
						<div class="modal-body">
							<!-- Zone d'alerte pour les erreurs globales -->
							<div id="formErrorAlert" class="alert alert-danger d-none" role="alert"></div>
							<div id="formSuccessAlert" class="alert alert-success d-none" role="alert"></div>

							<!-- Marque -->
							<div class="mb-3">
								<label for="brand" class="form-label">Marque *</label>
								<input type="text" class="form-control" id="brand" name="brand" required>
								<div class="invalid-feedback">
									Veuillez entrer une marque.
								</div>
							</div>

							<!-- Mod√®le -->
							<div class="mb-3">
								<label for="model" class="form-label">Mod√®le *</label>
								<input type="text" class="form-control" id="model" name="model" required>
								<div class="invalid-feedback">
									Veuillez entrer un mod√®le.
								</div>
							</div>

							<!-- Ann√©e -->
							<div class="mb-3">
								<label for="year" class="form-label">Ann√©e *</label>
								<input type="number" class="form-control" id="year" name="year" min="1900" max="2025" required>
								<div class="invalid-feedback">
									L'ann√©e doit √™tre entre 1900 et 2025.
								</div>
							</div>

							<!-- Couleur -->
							<div class="mb-3">
								<label for="color" class="form-label">Couleur *</label>
								<input type="text" class="form-control" id="color" name="color" required>
								<div class="invalid-feedback">
									Veuillez entrer une couleur.
								</div>
							</div>

							<!-- Prix -->
							<div class="mb-3">
								<label for="price" class="form-label">Prix (‚Ç¨) *</label>
								<input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
								<div class="invalid-feedback">
									Le prix doit √™tre un nombre positif.
								</div>
							</div>

							<!-- Kilom√©trage -->
							<div class="mb-3">
								<label for="mileage" class="form-label">Kilom√©trage *</label>
								<input type="number" class="form-control" id="mileage" name="mileage" min="0" required>
								<div class="invalid-feedback">
									Le kilom√©trage doit √™tre un nombre positif.
								</div>
							</div>

							<!-- Description -->
							<div class="mb-3">
								<label for="description" class="form-label">Description</label>
								<textarea class="form-control" id="description" name="description" rows="3"></textarea>
							</div>

							<!-- URL de l'image -->
							<div class="mb-3">
								<label for="imageUrl" class="form-label">URL de l'image</label>
								<input type="url" class="form-control" id="imageUrl" name="imageUrl" placeholder="https://exemple.com/image.jpg">
								<div class="invalid-feedback">
									Veuillez entrer une URL valide.
								</div>
								<div class="form-text">
									Optionnel. Si non renseign√©, une image par d√©faut sera utilis√©e.
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button
								type="button"
								class="btn btn-secondary"
								data-bs-dismiss="modal"
							>
								Annuler
							</button>
							<button type="button" class="btn btn-primary" id="submitButton">
								Ajouter la voiture
							</button>
						</div>
					</form>
					</div>
				</div>
			</div>

			<!-- Modal de confirmation de suppression -->
			<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="confirmDeleteModalLabel">Confirmer la suppression</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<p>√ätes-vous s√ªr de vouloir supprimer cette voiture ?</p>
							<p class="text-muted small mb-0">Cette action est irr√©versible.</p>
							<p id="deleteCarInfo" class="text-muted fst-italic mt-2"></p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
							<button type="button" class="btn btn-danger" id="confirmDeleteBtn">
								<span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
								Supprimer
							</button>
						</div>
					</div>
				</div>
			</div>
		</main>
		<footer class="text-muted py-5">
			<div class="container"></div>
		</footer>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
			crossorigin="anonymous"
		></script>
		
		<!-- Script inline pour intercepter le formulaire imm√©diatement -->
		<script>
			// File d'attente pour stocker les √©v√©nements si le module n'est pas pr√™t
			window._formSubmitQueue = [];
			
			// Fonction pour traiter la file d'attente
			function processFormSubmitQueue() {
				if (window._handleFormSubmitModule && window._formSubmitQueue.length > 0) {
					console.log('üì¶ Traitement de la file d\'attente:', window._formSubmitQueue.length, '√©v√©nement(s)');
					const events = window._formSubmitQueue.slice();
					window._formSubmitQueue = [];
					events.forEach(event => {
						window._handleFormSubmitModule(event);
					});
				}
			}
			
			// Fonction fallback pour soumettre directement si le module ne charge pas
			async function submitFormFallback(event) {
				console.log('‚ö†Ô∏è Utilisation de la fonction fallback pour soumettre le formulaire');
				const form = event.target || document.getElementById('addCarForm');
				if (!form) {
					console.error('Formulaire non trouv√©');
					return;
				}
				
				const submitButton = document.getElementById('submitButton');
				const originalText = submitButton ? submitButton.textContent : '';
				
				// D√©sactiver le bouton
				if (submitButton) {
					submitButton.disabled = true;
					submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Envoi en cours...';
				}
				
				try {
					// Effacer les alertes pr√©c√©dentes
					const errorAlert = document.getElementById('formErrorAlert');
					const successAlert = document.getElementById('formSuccessAlert');
					if (errorAlert) errorAlert.classList.add('d-none');
					if (successAlert) successAlert.classList.add('d-none');
					
					const formData = new FormData(form);
					const carData = Object.fromEntries(formData);
					
					// Convertir les types
					carData.year = parseInt(carData.year);
					carData.price = parseFloat(carData.price);
					carData.mileage = parseInt(carData.mileage);
					
					// Nettoyer les champs vides
					if (!carData.description || carData.description.trim() === '') {
						delete carData.description;
					}
					if (!carData.imageUrl || carData.imageUrl.trim() === '') {
						delete carData.imageUrl;
					}
					
					console.log('üì§ Envoi des donn√©es √† l\'API:', carData);
					
					// Envoyer directement √† l'API
					const response = await fetch('http://localhost:3000/api/cars', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Accept': 'application/json',
							'x-api-key': 'ma-super-cle-api-2024'
						},
						body: JSON.stringify(carData)
					});
					
					console.log('üì• R√©ponse du serveur:', response.status, response.statusText);
					
					if (response.ok) {
						const data = await response.json();
						console.log('‚úÖ Voiture cr√©√©e avec succ√®s:', data);
						
						// Afficher le message de succ√®s
						if (successAlert) {
							successAlert.classList.remove('d-none');
							successAlert.textContent = `‚úì La voiture "${carData.brand} ${carData.model}" a √©t√© ajout√©e avec succ√®s !`;
						}
						
						// R√©initialiser le formulaire
						form.reset();
						
						// Fermer le modal apr√®s un court d√©lai
						setTimeout(() => {
							const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
							if (modal) modal.hide();
							// Recharger la page pour voir la nouvelle voiture
							window.location.reload();
						}, 1500);
					} else {
						let errorMessage = `Erreur HTTP: ${response.status}`;
						try {
							const errorData = await response.json();
							errorMessage = errorData.error || errorData.message || errorMessage;
						} catch (e) {
							// Ignorer si on ne peut pas parser le JSON
						}
						
						// Afficher l'erreur
						if (errorAlert) {
							errorAlert.classList.remove('d-none');
							errorAlert.textContent = `Erreur: ${errorMessage}`;
						}
						
						// R√©activer le bouton
						if (submitButton) {
							submitButton.disabled = false;
							submitButton.textContent = originalText;
						}
					}
				} catch (error) {
					console.error('‚ùå Erreur:', error);
					
					// Afficher l'erreur
					const errorAlert = document.getElementById('formErrorAlert');
					if (errorAlert) {
						errorAlert.classList.remove('d-none');
						errorAlert.textContent = `Erreur r√©seau: ${error.message}`;
					}
					
					// R√©activer le bouton
					if (submitButton) {
						submitButton.disabled = false;
						submitButton.textContent = originalText;
					}
				}
			}
			
			// V√©rifier p√©riodiquement si le module est charg√©
			function waitForModule(event, maxAttempts = 20) {
				let attempts = 0;
				const checkInterval = setInterval(() => {
					attempts++;
					if (window._handleFormSubmitModule && typeof window._handleFormSubmitModule === 'function') {
						clearInterval(checkInterval);
						console.log('‚úÖ Module charg√© apr√®s', attempts * 100, 'ms');
						window._handleFormSubmitModule(event);
						processFormSubmitQueue();
					} else if (attempts >= maxAttempts) {
						clearInterval(checkInterval);
						console.warn('‚ö†Ô∏è Module non charg√© apr√®s', maxAttempts * 100, 'ms, utilisation du fallback');
						submitFormFallback(event);
					}
				}, 100);
			}
			
			// D√©finir la fonction globale imm√©diatement
			window.handleFormSubmitGlobal = function(event) {
				console.log('üîµ handleFormSubmitGlobal appel√©e (version inline)');
				event.preventDefault();
				event.stopPropagation();
				
				// Si le module est charg√©, l'utiliser imm√©diatement
				if (window._handleFormSubmitModule) {
					console.log('‚úÖ Module disponible, traitement imm√©diat');
					window._handleFormSubmitModule(event);
				} else {
					console.log('‚è≥ Module pas encore charg√©, mise en file d\'attente...');
					// Mettre en file d'attente
					window._formSubmitQueue.push(event);
					// Attendre que le module se charge
					waitForModule(event);
				}
				return false;
			};
			
			// Intercepter le formulaire d√®s que possible
			(function() {
				function interceptForm() {
					const form = document.getElementById('addCarForm');
					if (form) {
						console.log('‚úÖ Formulaire trouv√©, interception active');
						
						// Double protection : addEventListener et onsubmit
						form.addEventListener('submit', function(e) {
							console.log('üõë addEventListener : Interception de la soumission');
							e.preventDefault();
							e.stopPropagation();
							e.stopImmediatePropagation();
							window.handleFormSubmitGlobal(e);
							return false;
						}, true); // Capture phase - intercepte AVANT tout
						
						// Protection onsubmit
						form.onsubmit = function(e) {
							console.log('üõë onsubmit : Interception de la soumission');
							e.preventDefault();
							e.stopPropagation();
							window.handleFormSubmitGlobal(e);
							return false;
						};
						
						// Attacher un gestionnaire de clic au bouton submit
						const submitButton = document.getElementById('submitButton');
						if (submitButton) {
							console.log('‚úÖ Bouton submit trouv√©, attachement du gestionnaire de clic');
							submitButton.addEventListener('click', function(e) {
								console.log('üñ±Ô∏è Clic sur le bouton submit');
								e.preventDefault();
								
								// Cr√©er un √©v√©nement submit artificiel
								const submitEvent = new Event('submit', {
									bubbles: true,
									cancelable: true
								});
								
								// D√©clencher l'√©v√©nement submit sur le formulaire
								form.dispatchEvent(submitEvent);
							});
						}
					} else {
						// R√©essayer apr√®s un court d√©lai
						setTimeout(interceptForm, 100);
					}
				}
				
				// Essayer imm√©diatement et aussi apr√®s le chargement du DOM
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', interceptForm);
				} else {
					interceptForm();
				}
			})();
		</script>
		
		<script type="module" src="./js/script.js?v=7"></script>
	</body>
</html>
